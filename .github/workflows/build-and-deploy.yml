name: Build and Deploy APK

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths:
      - 'iptv-app/**'

permissions:
  contents: write

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      # 1. Descargar el código
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. Configurar Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: iptv-app/package-lock.json
      
      # 3. Instalar dependencias
      - name: Install dependencies
        working-directory: ./iptv-app
        run: npm ci
      
      # 4. Instalar EAS CLI
      - name: Install EAS CLI
        run: npm install -g eas-cli
      
      # 5. Compilar APK con Expo (EAS)
      - name: Build APK
        id: build
        working-directory: ./iptv-app
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "Iniciando build..."
          eas build --platform android --profile production --non-interactive
          
          echo "Esperando a que el build esté disponible..."
          sleep 10
          
          echo "Obteniendo información del último build..."
          BUILD_INFO=$(eas build:list --platform android --limit 1 --json --non-interactive)
          
          BUILD_URL=$(echo "$BUILD_INFO" | jq -r '.[0].artifacts.buildUrl // empty')
          
          if [ -z "$BUILD_URL" ]; then
            echo "❌ No se pudo obtener la URL del APK"
            echo "Build info:"
            echo "$BUILD_INFO"
            exit 1
          fi
          
          echo "✅ URL encontrada: $BUILD_URL"
          echo "BUILD_URL=$BUILD_URL" >> $GITHUB_OUTPUT
      
      # 6. Descargar APK generado
      - name: Download APK
        working-directory: ./iptv-app
        run: |
          curl -L "${{ steps.build.outputs.BUILD_URL }}" -o app.apk
      
      # 7. Obtener versión desde app.json
      - name: Get version
        id: version
        working-directory: ./iptv-app
        run: |
          VERSION=$(jq -r '.expo.version' app.json)
          if [ "$VERSION" = "null" ] || [ -z "$VERSION" ]; then
            echo "❌ No se pudo obtener la versión"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      # 8. Crear / actualizar Release en GitHub y subir APK
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Version ${{ steps.version.outputs.VERSION }}
          files: iptv-app/app.apk
          draft: false
          prerelease: false
          make_latest: true
          generate_release_notes: false
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 9. Actualizar config.json para Netlify
      - name: Update config.json
        run: |
          mkdir -p config-remota-netlify-deploy
          cat > config-remota-netlify-deploy/config.json << EOF
          {
            "servidor": "http://zgazy.com:8880",
            "servidores_backup": [
              "http://zona593.live:8080"
            ],
            "version_minima": "1.0.0",
            "mensaje_bienvenida": "Bienvenido a FRED TV",
            "mantenimiento": false,
            "mensaje_mantenimiento": "",
            "ultima_actualizacion": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "versionActual": "${{ steps.version.outputs.VERSION }}",
            "urlDescargaApk": "https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/app.apk",
            "fechaActualizacion": "$(date +'%Y-%m-%d')"
          }
          EOF
      
      # 10. Deploy a Netlify
      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: './config-remota-netlify-deploy'
          production-deploy: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
