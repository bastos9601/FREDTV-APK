name: Build and Deploy APK

# Cuándo se ejecuta
on:
  push:
    branches:
      - main
    paths:
      - 'iptv-app/**'

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      # 1. Descargar el código
      - name: Checkout code
        uses: actions/checkout@v3
      
      # 2. Configurar Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
      
      # 3. Instalar dependencias
      - name: Install dependencies
        working-directory: ./iptv-app
        run: npm install
      
      # 4. Instalar EAS CLI
      - name: Install EAS CLI
        run: npm install -g eas-cli
      
      # 5. Compilar APK y obtener URL
      - name: Build APK
        id: build
        working-directory: ./iptv-app
        run: |
          eas build --platform android --profile production --non-interactive > build-output.txt
          cat build-output.txt
          BUILD_URL=$(grep -oP 'https://expo.dev/artifacts/[a-zA-Z0-9-]+' build-output.txt | head -1)
          echo "BUILD_URL=$BUILD_URL" >> $GITHUB_OUTPUT
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      
      # 6. Descargar el APK
      - name: Download APK
        working-directory: ./iptv-app
        run: |
          curl -L -o app.apk "${{ steps.build.outputs.BUILD_URL }}"
      
      # 7. Obtener versión del app.json
      - name: Get version
        id: version
        working-directory: ./iptv-app
        run: |
          VERSION=$(cat app.json | jq -r '.expo.version')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      # 8. Crear Release en GitHub
      - name: Create or Update GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Version ${{ steps.version.outputs.VERSION }}
          files: ./iptv-app/app.apk
          draft: false
          prerelease: false
          make_latest: true
          fail_on_unmatched_files: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 9. Actualizar config.json
      - name: Update config.json
        run: |
          cat > config-remota-netlify-deploy/config.json << EOF
          {
            "versionActual": "${{ steps.version.outputs.VERSION }}",
            "urlDescargaApk": "https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/app.apk",
            "fechaActualizacion": "$(date +'%Y-%m-%d')"
          }
          EOF
      
      # 10. Subir a Netlify
      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: './config-remota-netlify-deploy'
          production-deploy: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
